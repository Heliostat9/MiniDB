# Использование MiniDB

MiniDB представляет собой минималистичную in-memory СУБД на Go с возможностью сохранения данных на диск в собственном бинарном формате. Ниже описано, как запустить базу и работать с ней через встроенный CLI.

## Требования
- Go 1.24 или новее

## Запуск
```bash
go run main.go
```
При старте база попытается загрузить данные из файла `data.mdb`. Если файл отсутствует, будет создана новая пустая база.

Дополнительно можно задать лимит строк и размер кэша результатов:

```bash
go run main.go -maxrows 500000 -cache 2097152
```

### HTTP режим

Для использования MiniDB через HTTP передайте флаг `-listen` со значением адреса:

```bash
go run main.go -listen :8080
```

Запросы отправляются методом POST на путь `/query` с текстом SQL в теле:

```bash
curl -X POST -d "SELECT * FROM users;" http://localhost:8080/query
```

## Основные команды CLI
- `CREATE TABLE <name> (<column> <type>, ...);` — создание таблицы.
- `INSERT INTO <name> VALUES (<value>, ...);` — вставка строки.
- `SELECT * FROM <name>;` — просмотр всех строк таблицы.
- `CREATE INDEX ON <table>(<column>);` — создание индекса по столбцу.
- `UPDATE <name> SET <column>='<value>' WHERE <column>='<cond>';` — обновление строк.
- `DUMP [filename];` — экспорт текущего состояния в SQL‑дамп.
- `EXIT;` — завершение работы.

Поддерживаются типы колонок `INT`, `FLOAT`, `BOOL` и `TEXT`. Если тип не указан, по умолчанию используется `TEXT`.
Команда `CREATE INDEX` позволяет ускорить выборку с условием, а кэширование результатов настраивается через флаг `-cache`.

## Пример сеанса
```sql
CREATE TABLE users (id INT, name TEXT);
CREATE TABLE metrics (score FLOAT, active BOOL);
INSERT INTO users VALUES (1, 'Alice');
INSERT INTO metrics VALUES (3.14, true);
SELECT * FROM metrics;
UPDATE users SET name='Bob' WHERE id=1;
DUMP backup.sql;
EXIT;
```

## Структура файла данных
Файл `data.mdb` содержит:
1. **Magic header** и номер версии формата (сейчас v3).
2. Список таблиц. Для каждой таблицы последовательно записываются:
   - имя таблицы;
   - список колонок с указанием их типов;
   - количество строк;
   - значения строк.

Журнал `data.wal` хранит последние изменения и воспроизводится при старте,
обеспечивая восстановление после сбоя.

Формат ориентирован на простоту, но версия v3 позволяет хранить до 10 млн строк в каждой таблице.

## Внутренние методы

Вся логика расположена в пакете `engine`. В нём реализованы следующие ключевые функции:

- `Init()` — загружает данные из бинарного файла при старте программы (`LoadBinaryDB`).
- `Execute(query string)` — точка входа из `main.go`, передаёт строку запроса в `HandleCommand` и возвращает результат.
- `HandleCommand(query string)` — разбирает команду и вызывает один из обработчиков ниже.
- `handleCreateTable`, `handleInsert`, `handleSelect`, `handleUpdate`, `handleDump` — реализуют соответствующие SQL‑операции и сохраняют данные через `SaveBinaryDB`.
- `SaveBinaryDB()` и `LoadBinaryDB()` — сериализация базы в файл `data.mdb` и загрузка обратно.
- `SaveSQLDump(filename string)` — экспортирует все таблицы в текстовый SQL‑дамп.

Таблицы хранятся в глобальной карте `Tables` (тип `map[string]*Table`).
Каждая таблица имеет собственный `RWMutex`, поэтому операции с разными таблицами могут выполняться параллельно.

## Тесты и их взаимодействие

Файл `db_test.go` содержит unit‑тесты на основные команды:

1. `TestHandleCreateTable` — проверяет создание таблицы и корректность типов колонок.
2. `TestHandleInsertAndSelect` — убеждается, что вставка строки и выборка через `SELECT` возвращают ожидаемые данные.
3. `TestHandleUpdate` — выполняет обновление строк и затем читает таблицу, чтобы убедиться в применении изменений.
4. `TestSaveSQLDump` — сохраняет дамп в файл и проверяет его содержимое.

Тесты используют те же функции пакета `engine`, что и исполняемый код. Перед каждым тестом глобальная карта `Tables` переинициализируется, чтобы изоляция была полной. Функции сериализации не вызываются напрямую, но `handleCreateTable`, `handleInsert` и другие внутри тестов автоматически сохраняют состояние через `SaveBinaryDB`, что также покрывается тестами на отсутствие ошибок.

## Подключение через `database/sql`

MiniDB можно использовать как обычную SQL-базу в Go-приложениях. Драйвер регистрируется при импорте пакета `minisql/driver`:

```go
import (
    "database/sql"
    _ "minisql/driver"
)

// имя драйвера — `minidb`
conn, _ := sql.Open("minidb", "")
```

После открытия можно выполнять SQL-запросы через методы `Exec` и `Query` стандартного `database/sql`.

### Транзакции

С версии 0.8 поддерживаются простые транзакции. В `database/sql` они начинаются через `db.Begin()`:

```go
tx, _ := conn.Begin()
tx.Exec("INSERT INTO demo VALUES (1)")
tx.Commit() // или tx.Rollback()
```

При использовании пакета `engine` напрямую аналогичный интерфейс доступен через `engine.BeginTx()`.
