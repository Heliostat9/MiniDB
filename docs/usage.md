# Использование MiniDB

MiniDB представляет собой минималистичную in-memory СУБД на Go с возможностью сохранения данных на диск в собственном бинарном формате. Ниже описано, как запустить базу и работать с ней через встроенный CLI.

## Требования
- Go 1.24 или новее

## Запуск
```bash
go run main.go
```
При старте база попытается загрузить данные из файла `data.mdb`. Если файл отсутствует, будет создана новая пустая база.

## Основные команды CLI
- `CREATE TABLE <name> (<column> <type>, ...);` — создание таблицы.
- `INSERT INTO <name> VALUES (<value>, ...);` — вставка строки.
- `SELECT * FROM <name>;` — просмотр всех строк таблицы.
- `UPDATE <name> SET <column>='<value>' WHERE <column>='<cond>';` — обновление строк.
- `DUMP [filename];` — экспорт текущего состояния в SQL‑дамп.
- `EXIT;` — завершение работы.

Поддерживаются типы колонок `INT` и `TEXT`. Если тип не указан, по умолчанию используется `TEXT`.

## Пример сеанса
```sql
CREATE TABLE users (id INT, name TEXT);
INSERT INTO users VALUES (1, 'Alice');
SELECT * FROM users;
UPDATE users SET name='Bob' WHERE id=1;
DUMP backup.sql;
EXIT;
```

## Структура файла данных
Файл `data.mdb` содержит:
1. **Magic header** и номер версии формата.
2. Список таблиц. Для каждой таблицы последовательно записываются:
   - имя таблицы;
   - список колонок с указанием их типов;
   - количество строк;
   - значения строк.

Формат предназначен для простоты и не предназначен для работы с очень большими объёмами данных.

## Внутренние методы

Вся логика расположена в пакете `engine`. В нём реализованы следующие ключевые функции:

- `Init()` — загружает данные из бинарного файла при старте программы (`LoadBinaryDB`).
- `Execute(query string)` — точка входа из `main.go`, передаёт строку запроса в `HandleCommand` и возвращает результат.
- `HandleCommand(query string)` — разбирает команду и вызывает один из обработчиков ниже.
- `handleCreateTable`, `handleInsert`, `handleSelect`, `handleUpdate`, `handleDump` — реализуют соответствующие SQL‑операции и сохраняют данные через `SaveBinaryDB`.
- `SaveBinaryDB()` и `LoadBinaryDB()` — сериализация базы в файл `data.mdb` и загрузка обратно.
- `SaveSQLDump(filename string)` — экспортирует все таблицы в текстовый SQL‑дамп.

Таблицы хранятся в глобальной карте `Tables` (тип `map[string]*Table`).
Каждая таблица имеет собственный `RWMutex`, поэтому операции с разными таблицами могут выполняться параллельно.

## Тесты и их взаимодействие

Файл `db_test.go` содержит unit‑тесты на основные команды:

1. `TestHandleCreateTable` — проверяет создание таблицы и корректность типов колонок.
2. `TestHandleInsertAndSelect` — убеждается, что вставка строки и выборка через `SELECT` возвращают ожидаемые данные.
3. `TestHandleUpdate` — выполняет обновление строк и затем читает таблицу, чтобы убедиться в применении изменений.
4. `TestSaveSQLDump` — сохраняет дамп в файл и проверяет его содержимое.

Тесты используют те же функции пакета `engine`, что и исполняемый код. Перед каждым тестом глобальная карта `Tables` переинициализируется, чтобы изоляция была полной. Функции сериализации не вызываются напрямую, но `handleCreateTable`, `handleInsert` и другие внутри тестов автоматически сохраняют состояние через `SaveBinaryDB`, что также покрывается тестами на отсутствие ошибок.
